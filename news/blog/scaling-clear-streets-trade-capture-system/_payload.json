[{"data":1,"prerenderedAt":971},["ShallowReactive",2],{"6sE2tRinmd":3},{"pageSetup":4,"sections":15},{"keywords":5,"image":6,"title":10,"slug":11,"description":14},null,{"url":7,"width":8,"height":9},"https://cdn.sanity.io/images/40fnhjbe/production/f519c79e48e8459d4f43c2cf84c5b52d145c27ef-3840x2160.png",3840,2160,"Scaling Clear Street’s Trade Capture System",{"current":12,"_type":13},"scaling-clear-streets-trade-capture-system","slug","Clear Street is a cloud-native financial technology firm on a mission to modernize the brokerage ecosystem.",{"header":16,"content":39,"footer":882},{"summary":14,"author":17,"category":34,"title":10,"date":37,"hello":38},{"name":18,"_type":19,"_rev":20,"_id":21,"_updatedAt":22,"slug":23,"role":25,"photo":26,"_createdAt":33},"Clear Street Engineering","authors","oquihqXh9OzAvkinFGpwlk","FY3Umrpkptjq2bXyZZikKw","2024-05-30T15:04:12Z",{"current":24,"_type":13},"clear-street-engineering","",{"height":27,"extension":28,"alt":5,"hotspot":5,"asset":29,"url":32,"width":27},480,"png",{"_ref":30,"_type":31},"image-f9f54b5f5240dfdb9749b6abea1e0ea4720c0dee-480x480-png","reference","https://cdn.sanity.io/images/40fnhjbe/production/f9f54b5f5240dfdb9749b6abea1e0ea4720c0dee-480x480.png","2024-02-16T14:38:42Z",{"name":35,"colorSlug":36},"Engineering","engineering","2021-08-19","world",{"form":40,"type":69,"readingTime":70,"body":71,"references":815,"pressReleasesFootNote":816,"legalText":843},{"title":41,"slug":42,"fields":43},"Contact","contact",[44,50,55,60,64],{"name":45,"label":46,"required":47,"errorMessage":48,"_type":49},"full-name","Full name",true,"Please add your full name","field.string",{"name":51,"label":52,"required":47,"errorMessage":53,"_type":54},"work-email","Work email","Invalid email","field.email",{"_type":56,"name":57,"label":58,"required":47,"errorMessage":59},"field.phone","work-phone","Work phone","Please add your work phone",{"errorMessage":61,"_type":49,"name":62,"label":63,"required":47},"Please add your company","company","Company",{"name":65,"label":66,"required":67,"errorMessage":5,"_type":68},"message","Message (optional)",false,"field.text","blog",11,[72,82,90,100,120,128,136,143,195,202,211,218,226,236,251,259,267,279,291,303,315,322,329,337,345,352,360,367,374,382,401,409,439,447,455,462,481,488,495,502,514,522,530,537,549,561,573,614,621,640,648,656,663,670,693,725,747,755,763,770,777,785,792,800,807],{"children":73,"_type":78,"style":79,"_key":80,"markDefs":81},[74],{"_type":75,"marks":76,"text":25,"_key":77},"span",[],"50815e4e67660","block","normal","50815e4e6766",[],{"style":79,"_key":83,"markDefs":84,"children":85,"_type":78},"6cad9be08703",[],[86],{"_type":75,"marks":87,"text":88,"_key":89},[],"At the heart of Clear Street’s technical machinery is our Trade Capture system, responsible for processing, clearing, and settling all incoming trades into our platform. The first version of the system was designed to support the initial, invitation-only launch of our platform. In the coming years, we expect to support 100x our initial trade volume and beyond. To support an expansion of that magnitude, we needed a fundamental redesign — one that easily adapts to our continuous growth.","6cad9be087030",{"style":91,"_key":92,"markDefs":93,"children":94,"_type":78},"h5","d25415e38ef7",[],[95],{"_type":75,"marks":96,"text":98,"_key":99},[97],"strong","Background","d25415e38ef70",{"markDefs":101,"children":106,"_type":78,"style":79,"_key":119},[102],{"to":103,"_key":104,"_type":105},"https://books.google.com/books/about/After_the_Trade_is_Made.html?id=hAVpBSPyIgQC","9b33a1d91865","link",[107,111,115],{"marks":108,"text":109,"_key":110,"_type":75},[],"Let’s start with a brief summary of the post-trade workflow, to provide more context regarding the technical decisions made. What follows is by no means an exhaustive overview of the full trade lifecycle (there’s literally an entire ","67174ff7a7cf0",{"_type":75,"marks":112,"text":113,"_key":114},[104],"book","67174ff7a7cf1",{"_type":75,"marks":116,"text":117,"_key":118},[]," written on that), but we’ll give this concise explanation of the relevant parts in this blog post. (Note that for this discussion we’ve focused on the process for U.S. equities only).","67174ff7a7cf2","67174ff7a7cf",{"_type":78,"style":91,"_key":121,"markDefs":122,"children":123},"55d04346e689",[],[124],{"_type":75,"marks":125,"text":126,"_key":127},[97],"Life of a Trade","55d04346e6890",{"markDefs":129,"children":130,"_type":78,"style":79,"_key":135},[],[131],{"marks":132,"text":133,"_key":134,"_type":75},[],"Orders initially go through an Order Management System (OMS), which is in charge of execution. Each order is then routed to an exchange or market center (e.g., NYSE) that matches orders between buyer and seller of the stock. When a match is found, the exchange informs the OMS of the successful execution of the order, at which point it becomes a trade. After that, the OMS routes the trade to a Clearing System (e.g., Clear Street) that is responsible for the clearing and settlement process.","1075643c82f90","1075643c82f9",{"children":137,"_type":78,"style":79,"_key":141,"markDefs":142},[138],{"_key":139,"_type":75,"marks":140,"text":25},"d96f247efdde0",[],"d96f247efdde",[],{"children":144,"_type":78,"style":79,"_key":185,"markDefs":186},[145,149,154,158,163,167,172,176,181],{"text":146,"_key":147,"_type":75,"marks":148},"In conjunction, trades from all market centers are routed to the ","bb4340044bb10",[],{"text":150,"_key":151,"_type":75,"marks":152},"NSCC","bb4340044bb11",[153],"4b7ec4fa9a29",{"text":155,"_key":156,"_type":75,"marks":157}," (in the US), which in turn sends instructions on the trade to the Clearing System over a ","bb4340044bb12",[],{"_type":75,"marks":159,"text":161,"_key":162},[160],"1da279f3ff52","FIX","bb4340044bb13",{"marks":164,"text":165,"_key":166,"_type":75},[]," connection through ","bb4340044bb14",{"marks":168,"text":170,"_key":171,"_type":75},[169],"e97468f04448","UTC","bb4340044bb15",{"_type":75,"marks":173,"text":174,"_key":175},[]," protocol. A reconciliation process occurs to match house trades (from OMS) and street trades (from NSCC). After 2 days, the trade is settled (i.e., shares between the two parties involved in the trade are exchanged) through a process called continuous net settlement (","bb4340044bb16",{"text":177,"_key":178,"_type":75,"marks":179},"CNS","bb4340044bb17",[180],"f3d6bd8226ca",{"text":182,"_key":183,"_type":75,"marks":184},").","bb4340044bb18",[],"bb4340044bb1",[187,189,191,193],{"to":188,"_key":153,"_type":105},"https://www.dtcc.com/about/businesses-and-subsidiaries/nscc",{"_type":105,"to":190,"_key":160},"https://en.wikipedia.org/wiki/Financial_Information_eXchange",{"_type":105,"to":192,"_key":169},"https://dtcclearning.com/products-and-services/equities-clearing/universal-trade-capture-utc.html",{"_type":105,"to":194,"_key":180},"https://www.investopedia.com/terms/c/cns.asp",{"markDefs":196,"children":197,"_type":78,"style":79,"_key":201},[],[198],{"text":25,"_key":199,"_type":75,"marks":200},"9fe62034d66b0",[],"9fe62034d66b",{"alt":25,"caption":203,"asset":204,"hotspot":5,"url":206,"height":207,"extension":28,"_type":208,"_key":209,"children":5,"width":210},[],{"_ref":205,"_type":31},"image-266c3c03561ddc31916fbd3f248bb5b6310c5ea0-1400x560-png","https://cdn.sanity.io/images/40fnhjbe/production/266c3c03561ddc31916fbd3f248bb5b6310c5ea0-1400x560.png",560,"figureNews","b3591761bb4c",1400,{"markDefs":212,"children":213,"_type":78,"style":79,"_key":217},[],[214],{"text":25,"_key":215,"_type":75,"marks":216},"693b97bc4f340",[],"693b97bc4f34",{"markDefs":219,"children":220,"_type":78,"style":79,"_key":225},[],[221],{"_type":75,"marks":222,"text":223,"_key":224},[],"As shown above, there are 3 main ingress points for trades incoming from the Order Management System (OMS) into our clearing system:","16decabef0d50","16decabef0d5",{"listItem":227,"markDefs":228,"children":229,"level":234,"_type":78,"style":79,"_key":235},"bullet",[],[230],{"_type":75,"marks":231,"text":232,"_key":233},[],"HTTP requests to our client-facing API endpoints","9dc15e9a9df00",1,"9dc15e9a9df0",{"style":79,"_key":237,"listItem":227,"markDefs":238,"children":242,"level":234,"_type":78},"b1239e1fd486",[239],{"_type":105,"to":240,"_key":241},"https://aws.amazon.com/s3/","44f5a73015a3",[243,247],{"_type":75,"marks":244,"text":245,"_key":246},[],"CSV files ingested via FTP, and uploaded to AWS ","b1239e1fd4860",{"_key":248,"_type":75,"marks":249,"text":250},"b1239e1fd4861",[241],"S3",{"listItem":227,"markDefs":252,"children":253,"level":234,"_type":78,"style":79,"_key":258},[],[254],{"text":255,"_key":256,"_type":75,"marks":257},"Trade ingestion via FIX, transformed into Kafka events","6a0a52b93f590",[],"6a0a52b93f59",{"_type":78,"style":79,"_key":260,"markDefs":261,"children":262},"cb6bb40e1edc",[],[263],{"text":264,"_key":265,"_type":75,"marks":266},"After a trade is matched and cleared, it transitions through several stages during its lifetime toward being settled. The primary states of interest are:","cb6bb40e1edc0",[],{"children":268,"level":234,"_type":78,"style":79,"_key":277,"listItem":227,"markDefs":278},[269,273],{"_type":75,"marks":270,"text":271,"_key":272},[97],"Cleared:","b60a648388fd0",{"_type":75,"marks":274,"text":275,"_key":276},[]," On creation, a trade’s details are verified to ensure they match with our records.","b60a648388fd1","b60a648388fd",[],{"children":280,"level":234,"_type":78,"style":79,"_key":289,"listItem":227,"markDefs":290},[281,285],{"_type":75,"marks":282,"text":283,"_key":284},[97],"Settled:","47ab875c87380",{"_type":75,"marks":286,"text":287,"_key":288},[]," A trade enters a settlement period, which gives the buyer and seller time to do what’s necessary to fulfill their part of the trade. This is typically 2 business days (i.e., T+2) after the trade date, as determined by the SEC.","47ab875c87381","47ab875c8738",[],{"level":234,"_type":78,"style":79,"_key":292,"listItem":227,"markDefs":293,"children":294},"f1ed4214752e",[],[295,299],{"_type":75,"marks":296,"text":297,"_key":298},[97],"Failed","f1ed4214752e0",{"_type":75,"marks":300,"text":301,"_key":302},[],": Trades that cannot be settled through CNS qualify for fail processing. That workflow undergoes additional stages before getting settled. (Those stages are not covered here for brevity.)","f1ed4214752e1",{"style":79,"_key":304,"listItem":227,"markDefs":305,"children":306,"level":234,"_type":78},"2df7195f2065",[],[307,311],{"_type":75,"marks":308,"text":309,"_key":310},[97],"Cancelled:","2df7195f20650",{"_key":312,"_type":75,"marks":313,"text":314},"2df7195f20651",[]," A trade can be cancelled at any point within its lifecycle, even after clearing or settlement. The cancelled state is terminal.",{"style":79,"_key":316,"markDefs":317,"children":318,"_type":78},"f6f48b1baa08",[],[319],{"_type":75,"marks":320,"text":25,"_key":321},[],"f6f48b1baa080",{"hotspot":5,"url":323,"width":210,"height":324,"children":5,"alt":25,"caption":325,"extension":28,"_type":208,"_key":326,"asset":327},"https://cdn.sanity.io/images/40fnhjbe/production/628cbfd9b6ff338cf415c328643c07ff13d3348d-1400x1044.png",1044,[],"4d7f60d94ab1",{"_type":31,"_ref":328},"image-628cbfd9b6ff338cf415c328643c07ff13d3348d-1400x1044-png",{"_type":78,"style":91,"_key":330,"markDefs":331,"children":332},"0a4590bcb6d1",[],[333],{"marks":334,"text":335,"_key":336,"_type":75},[97],"Architecture","0a4590bcb6d10",{"markDefs":338,"children":339,"_type":78,"style":79,"_key":344},[],[340],{"_key":341,"_type":75,"marks":342,"text":343},"91afa16fddc60",[],"As mentioned earlier, a primary goal in our system’s new design was accommodating for high throughput traffic and enabling horizontal scale. That said, it cannot come at a compromise to consistency and integrity of behavior, since there are serious implications in certain situations. The system can be latency-tolerant, with sub-second processing time. Availability should be fairly high to ensure no prolonged downtime for our system, however we do want to gracefully handle extended periods of failures without interrupting the trade flow incoming from clients. These are some of the considerations that were in mind when we were devising the design.","91afa16fddc6",{"_type":78,"style":79,"_key":346,"markDefs":347,"children":348},"4d2cb70b4176",[],[349],{"_type":75,"marks":350,"text":25,"_key":351},[],"4d2cb70b41760",{"_key":353,"markDefs":354,"children":355,"_type":78,"style":79},"7553eb10b56c",[],[356],{"_type":75,"marks":357,"text":358,"_key":359},[],"The below figure depicts a simplified high-level design of our system. We’ll drill into the main components in what follows.","7553eb10b56c0",{"_type":78,"style":79,"_key":361,"markDefs":362,"children":363},"3d3da587a7c2",[],[364],{"_key":365,"_type":75,"marks":366,"text":25},"3d3da587a7c20",[],{"extension":28,"url":368,"_key":369,"asset":370,"children":5,"_type":208,"alt":25,"caption":372,"height":373,"hotspot":5,"width":210},"https://cdn.sanity.io/images/40fnhjbe/production/81aeca35c16e539839836ed671b0e04c5cf60fca-1400x1121.png","bd22d8c01444",{"_ref":371,"_type":31},"image-81aeca35c16e539839836ed671b0e04c5cf60fca-1400x1121-png",[],1121,{"markDefs":375,"children":376,"_type":78,"style":91,"_key":381},[],[377],{"_type":75,"marks":378,"text":379,"_key":380},[97],"Gateway","d46d6b72d5940","d46d6b72d594",{"_key":383,"markDefs":384,"children":388,"_type":78,"style":79},"0d4725cc7eb3",[385],{"_type":105,"to":386,"_key":387},"https://microservices.io/patterns/apigateway.html","e483db4f9c2f",[389,393,397],{"_type":75,"marks":390,"text":391,"_key":392},[],"The Gateway component serves as a common ","0d4725cc7eb30",{"text":394,"_key":395,"_type":75,"marks":396},"API Gateway","0d4725cc7eb31",[387],{"_type":75,"marks":398,"text":399,"_key":400},[]," for all trade requests (read and write paths). Unifying the API interface simplifies client integration, and also effectively abstracts the remainder of the system. All necessary transformation and validation logic on receiving a trade request is performed upfront in the Gateway. This ensures, to the extent possible, that we maintain the integrity of data propagated downstream. To improve isolation, we have a different gateway role for each input type (e.g., file, stream, API), which can be scaled independently.","0d4725cc7eb32",{"children":402,"_type":78,"style":91,"_key":407,"markDefs":408},[403],{"_type":75,"marks":404,"text":405,"_key":406},[97],"Event Source","36f5f001954e0","36f5f001954e",[],{"markDefs":410,"children":417,"_type":78,"style":79,"_key":438},[411,414],{"_type":105,"to":412,"_key":413},"https://kafka.apache.org/","6aef63f824a4",{"_type":105,"to":415,"_key":416},"https://microservices.io/patterns/data/event-sourcing.html","46539b9f883c",[418,422,426,430,434],{"text":419,"_key":420,"_type":75,"marks":421},"After a trade request is processed, it gets transformed to a transaction (i.e., trade action) and is published to our event bus (","067f10fa15240",[],{"text":423,"_key":424,"_type":75,"marks":425},"Kafka","067f10fa15241",[413],{"_type":75,"marks":427,"text":428,"_key":429},[],"). The design aims at leveraging ","067f10fa15242",{"_type":75,"marks":431,"text":432,"_key":433},[416],"event sourcing","067f10fa15243",{"_type":75,"marks":435,"text":436,"_key":437},[],", specifically in relying on an event stream that acts as a source-of-truth for all transactions committed to our system. Persisting directly to Kafka and bypassing the database on the critical path relieves request serving from being storage-bound, and results in a considerable improvement to performance, throughput, and scalability considerations.","067f10fa15244","067f10fa1524",{"children":440,"_type":78,"style":91,"_key":445,"markDefs":446},[441],{"_type":75,"marks":442,"text":443,"_key":444},[97],"Dated Topics","22b8885cba010","22b8885cba01",[],{"_key":448,"markDefs":449,"children":450,"_type":78,"style":79},"7b341e9d0e69",[],[451],{"_key":452,"_type":75,"marks":453,"text":454},"7b341e9d0e690",[],"Transactions are associated with an effective date (on which they are executed) that can be set for a future date. For example, a settlement transaction is created on trade creation, which is scheduled 2 days from when the trade is made. Furthermore, events are received within a set time window during the day, after which there is a cutoff to the next day. The process of transitioning to the next trading date is called “rollover.”",{"markDefs":456,"children":457,"_type":78,"style":79,"_key":461},[],[458],{"_type":75,"marks":459,"text":25,"_key":460},[],"fafb887542e40","fafb887542e4",{"children":463,"_type":78,"style":79,"_key":477,"markDefs":478},[464,468,473],{"_key":465,"_type":75,"marks":466,"text":467},"ea93483e719d0",[],"To address the above requirements, we decided to create a Kafka topic per date. This helps achieve a clean partition between trading activity within a day, and allows us to defer execution of transactions by inserting in a future dated topic. For requests resulting in transactions across multiple days, we leverage Kafka’s ",{"marks":469,"text":471,"_key":472,"_type":75},[470],"3807ca35ceba","transactional","ea93483e719d1",{"text":474,"_key":475,"_type":75,"marks":476}," producer to ensure atomicity of the operation. Lastly, the downstream consumer would switch to consume from the new date topics on rollover.","ea93483e719d2",[],"ea93483e719d",[479],{"_type":105,"to":480,"_key":470},"https://www.confluent.io/blog/transactions-apache-kafka/",{"markDefs":482,"children":483,"_type":78,"style":79,"_key":487},[],[484],{"_type":75,"marks":485,"text":25,"_key":486},[],"1f8811a3cf1b0","1f8811a3cf1b",{"height":489,"extension":28,"hotspot":5,"asset":490,"children":5,"alt":25,"_key":492,"_type":208,"caption":493,"url":494,"width":210},838,{"_ref":491,"_type":31},"image-f2d83ba1822d1622bf8ab30df6eb81495395ff06-1400x838-png","a39a13f4436b",[],"https://cdn.sanity.io/images/40fnhjbe/production/f2d83ba1822d1622bf8ab30df6eb81495395ff06-1400x838.png",{"children":496,"_type":78,"style":79,"_key":500,"markDefs":501},[497],{"_type":75,"marks":498,"text":25,"_key":499},[],"f01b9d3bddd60","f01b9d3bddd6",[],{"markDefs":503,"children":504,"_type":78,"style":79,"_key":513},[],[505,509],{"_type":75,"marks":506,"text":507,"_key":508},[97],"Note","b613d186e7bc0",{"_type":75,"marks":510,"text":511,"_key":512},[],": Currently, the settlement cadence for incoming trades is 2 days (T+2), since we primarily operate in the US at the moment. However, the system can easily accommodate for T+N settlements where N >= 0","b613d186e7bc1","b613d186e7bc",{"markDefs":515,"children":516,"_type":78,"style":91,"_key":521},[],[517],{"_type":75,"marks":518,"text":519,"_key":520},[97],"Processors","8044ca84a0c70","8044ca84a0c7",{"_key":523,"markDefs":524,"children":525,"_type":78,"style":79},"e234e68ef02e",[],[526],{"_key":527,"_type":75,"marks":528,"text":529},"e234e68ef02e0",[],"On the receiving end, we maintain 3 main materialized views of the transaction stream:",{"_type":78,"style":79,"_key":531,"markDefs":532,"children":533},"def781a476d8",[],[534],{"_type":75,"marks":535,"text":25,"_key":536},[],"def781a476d80",{"_type":78,"style":79,"_key":538,"listItem":227,"markDefs":539,"children":540,"level":234},"4dd92034c1ee",[],[541,545],{"_type":75,"marks":542,"text":543,"_key":544},[97],"State View","4dd92034c1ee0",{"marks":546,"text":547,"_key":548,"_type":75},[],": tracks state of all trades as presented in the trade lifecycle.","4dd92034c1ee1",{"level":234,"_type":78,"style":79,"_key":550,"listItem":227,"markDefs":551,"children":552},"26f78f55d47f",[],[553,557],{"_type":75,"marks":554,"text":555,"_key":556},[97],"Audit Log","26f78f55d47f0",{"marks":558,"text":559,"_key":560,"_type":75},[],": stores an audit trail of transactions for historical purposes.","26f78f55d47f1",{"children":562,"level":234,"_type":78,"style":79,"_key":571,"listItem":227,"markDefs":572},[563,567],{"_key":564,"_type":75,"marks":565,"text":566},"13042d4511b00",[97],"Ledgers",{"_key":568,"_type":75,"marks":569,"text":570},"13042d4511b01",[],": maintains a bookkeeping view of client accounts, used for financial reporting.","13042d4511b0",[],{"style":79,"_key":574,"markDefs":575,"children":585,"_type":78},"6d341bf28e8b",[576,579,582],{"_type":105,"to":577,"_key":578},"https://en.wikipedia.org/wiki/Separation_of_concerns","4a534039ed5e",{"_type":105,"to":580,"_key":581},"https://martinfowler.com/bliki/CQRS.html","055305ca322f",{"_type":105,"to":583,"_key":584},"https://en.wikipedia.org/wiki/Single_point_of_failure","ebcccaca4026",[586,590,594,598,602,606,610],{"_type":75,"marks":587,"text":588,"_key":589},[],"We chose to segregate the processors for the different views to enable parallelization and promote separation of concerns (","6d341bf28e8b0",{"_type":75,"marks":591,"text":592,"_key":593},[578],"SoC","6d341bf28e8b1",{"marks":595,"text":596,"_key":597,"_type":75},[],"). This also gives us flexibility in optimizing the query patterns for each view, for instance by adopting a different storage solution for each (e.g., PostgreSQL for ledgers, DynamoDB for audit trail). This lends itself to the ","6d341bf28e8b2",{"_type":75,"marks":599,"text":600,"_key":601},[581],"CQRS","6d341bf28e8b3",{"marks":603,"text":604,"_key":605,"_type":75},[]," pattern, where read and write data models can naturally diverge. Isolation also alleviates a single point-of-failure (","6d341bf28e8b4",{"marks":607,"text":608,"_key":609,"_type":75},[584],"SPoF","6d341bf28e8b5",{"_type":75,"marks":611,"text":612,"_key":613},[],") in the system, and allows for independent scaling.","6d341bf28e8b6",{"children":615,"_type":78,"style":79,"_key":619,"markDefs":620},[616],{"_type":75,"marks":617,"text":25,"_key":618},[],"14ff7f17cef80","14ff7f17cef8",[],{"_key":622,"markDefs":623,"children":627,"_type":78,"style":79},"3cd402efb8e3",[624],{"_type":105,"to":625,"_key":626},"https://en.wikipedia.org/wiki/Eventual_consistency#:~:text=Eventual%20consistency%20is%20a%20consistency,return%20the%20last%20updated%20value.","eb5eb823e12e",[628,632,636],{"marks":629,"text":630,"_key":631,"_type":75},[],"A tradeoff with this approach is tolerance to ","3cd402efb8e30",{"text":633,"_key":634,"_type":75,"marks":635},"eventual consistency","3cd402efb8e31",[626],{"_type":75,"marks":637,"text":638,"_key":639},[],"; we can incur a lag in updating views as a consequence of consuming events off of a stream. Additionally, given each workflow is processed independently, there is no guarantee at a given time that all views are in sync. In our case, a small lag is tolerable since the processors are mostly independent.","3cd402efb8e32",{"_key":641,"markDefs":642,"children":643,"_type":78,"style":91},"8ddcf33fc344",[],[644],{"_type":75,"marks":645,"text":646,"_key":647},[97],"Retryer","8ddcf33fc3440",{"_type":78,"style":79,"_key":649,"markDefs":650,"children":651},"36515c2a6bff",[],[652],{"text":653,"_key":654,"_type":75,"marks":655},"On transient failures, we want a reliable manner to retry operations without blocking execution or failing hard. Examples would be race conditions, database glitches, or connectivity issues that can naturally be resolved by inducing processing delay. The majority of failures in this category can be resolved by adding more resiliency in the app layer (e.g., request retry logic). However, some resolvable failures can be more prolonged (e.g., not being able to resolve a trade’s stock symbol). To handle these situations gracefully, we introduce the following staged retry mechanism:","36515c2a6bff0",[],{"children":657,"_type":78,"style":79,"_key":661,"markDefs":662},[658],{"_type":75,"marks":659,"text":25,"_key":660},[],"7219aa41409f0","7219aa41409f",[],{"_key":664,"height":665,"url":666,"width":210,"asset":667,"children":5,"_type":208,"alt":25,"caption":669,"extension":28,"hotspot":5},"a75a97070dbf",1154,"https://cdn.sanity.io/images/40fnhjbe/production/95d43e946c33ad47ae0833a3cf08561ad3f38806-1400x1154.png",{"_ref":668,"_type":31},"image-95d43e946c33ad47ae0833a3cf08561ad3f38806-1400x1154-png",[],{"_type":78,"style":79,"_key":671,"listItem":227,"markDefs":672,"children":676,"level":234},"0c8697366cb9",[673],{"to":674,"_key":675,"_type":105},"https://aws.amazon.com/sqs/","08cbddd96029",[677,681,685,689],{"_type":75,"marks":678,"text":679,"_key":680},[97],"Retry Queue:","0c8697366cb90",{"_type":75,"marks":682,"text":683,"_key":684},[]," Failed transactions that are retryable are added to a retry queue, scheduled for processing after an induced delay. On retry, the transaction is sent through to the gateway to be re-processed. Failures are repeatedly inserted into the retry queue up to a set retry count limit. We can also have several retry layers with varying settings as needed. We leverage ","0c8697366cb91",{"_key":686,"_type":75,"marks":687,"text":688},"0c8697366cb92",[675],"SQS",{"_type":75,"marks":690,"text":691,"_key":692},[]," for our retry queues, given its FIFO semantics, exactly-once guarantee, and delayed execution features.","0c8697366cb93",{"_type":78,"style":79,"_key":694,"listItem":227,"markDefs":695,"children":701,"level":234},"7687e4eb9655",[696,699],{"_type":105,"to":697,"_key":698},"https://en.wikipedia.org/wiki/Dead_letter_queue","31bdff27a2ca",{"_type":105,"to":697,"_key":700},"93d936061447",[702,706,710,714,718,721],{"_type":75,"marks":703,"text":704,"_key":705},[97],"Dead-Letter Queue (","7687e4eb96550",{"_key":707,"_type":75,"marks":708,"text":709},"7687e4eb96551",[698,97],"DLQ",{"_type":75,"marks":711,"text":712,"_key":713},[97],")","7687e4eb96552",{"marks":715,"text":716,"_key":717,"_type":75},[],": Failed requests that exceed the retry limit, or require manual intervention, are added to a ","7687e4eb96553",{"marks":719,"text":709,"_key":720,"_type":75},[700],"7687e4eb96554",{"_type":75,"marks":722,"text":723,"_key":724},[],". The operations team is consequently notified to try and resolve the issue or notify the client of the failure. These cases are usually very rare, given most error categories are remediable.","7687e4eb96555",{"_type":78,"style":79,"_key":726,"markDefs":727,"children":731},"1a4ca545c989",[728],{"_type":105,"to":729,"_key":730},"https://eng.uber.com/reliable-reprocessing/","0f926d51f760",[732,735,739,743],{"_key":733,"_type":75,"marks":734,"text":507},"1a4ca545c9890",[97],{"_type":75,"marks":736,"text":737,"_key":738},[],": Uber adopted a similar ","1a4ca545c9891",{"_type":75,"marks":740,"text":741,"_key":742},[730],"solution","1a4ca545c9892",{"text":744,"_key":745,"_type":75,"marks":746},", which is worth the read.","1a4ca545c9893",[],{"_type":78,"style":91,"_key":748,"markDefs":749,"children":750},"787a80ff3694",[],[751],{"_type":75,"marks":752,"text":753,"_key":754},[97],"Conclusion","787a80ff36940",{"markDefs":756,"children":757,"_type":78,"style":79,"_key":762},[],[758],{"marks":759,"text":760,"_key":761,"_type":75},[],"With the new design, we’ve considerably improved the scalability of our system. We can seamlessly adapt to traffic growth by adding more compute and/or resizing our Kafka cluster (i.e., horizontal scaling). The main unit of scale that reflects how much throughput the system can accommodate is the number of partitions per dated topics. Additionally, segregation of data persistence for each processor allows us to scale our database layer independently, or consider different storage solutions for each workflow as suitable","f283236002300","f28323600230",{"_key":764,"markDefs":765,"children":766,"_type":78,"style":79},"93fa390d9d54",[],[767],{"_type":75,"marks":768,"text":25,"_key":769},[],"93fa390d9d540",{"_key":771,"asset":772,"children":5,"extension":28,"hotspot":5,"width":210,"height":774,"_type":208,"alt":25,"caption":775,"url":776},"23f75fa62e72",{"_ref":773,"_type":31},"image-0c276ffe867af99b54822a23dcc2546139b26557-1400x619-png",619,[],"https://cdn.sanity.io/images/40fnhjbe/production/0c276ffe867af99b54822a23dcc2546139b26557-1400x619.png",{"_type":78,"style":79,"_key":778,"markDefs":779,"children":780},"2b7b295514fe",[],[781],{"_type":75,"marks":782,"text":783,"_key":784},[],"There were many more underlying technical challenges inherent in designing and implementing this system that weren’t portrayed here, some of which were quite interesting and unique to our problem space. We’ll shed more light on those problems and how we addressed them in future posts. Stay tuned!","2b7b295514fe0",{"markDefs":786,"children":787,"_type":78,"style":79,"_key":791},[],[788],{"_type":75,"marks":789,"text":25,"_key":790},[],"9609239404200","960923940420",{"_key":793,"markDefs":794,"children":795,"_type":78,"style":79},"3b61c6750eff",[],[796],{"_type":75,"marks":797,"text":798,"_key":799},[],"Yours Truly,","3b61c6750eff0",{"_key":801,"markDefs":802,"children":803,"_type":78,"style":79},"c901696dca0c",[],[804],{"_type":75,"marks":805,"text":25,"_key":806},[],"c901696dca0c0",{"_type":78,"style":79,"_key":808,"markDefs":809,"children":810},"6aecce155c74",[],[811],{"_type":75,"marks":812,"text":813,"_key":814},[],"Platform Engineering, Core Systems Team","6aecce155c740",[],[817,825],{"markDefs":818,"children":819,"_type":78,"style":79,"_key":824},[],[820],{"_type":75,"marks":821,"text":822,"_key":823},[97],"About Clear Street:","820e76cb468a0","01d9743bd6e6",{"markDefs":826,"children":830,"_type":78,"style":79,"_key":842},[827],{"_type":105,"href":828,"_key":829},"https://clearstreet.io","f69e401d33e9",[831,835,838],{"_type":75,"marks":832,"text":833,"_key":834},[],"Clear Street is modernizing the brokerage ecosystem with financial technology and services that empower market participants with real-time data and best-in-class products, tools and teams, to navigate capital markets around the world. Complemented by white-glove service, Clear Street's cloud-native, proprietary product suite delivers financing, derivatives, execution and more to power client success, adding efficiency to the market and enabling clients to minimize risk, redundancy and cost. Clear Street’s goal is to create a single platform for every asset class, in every country and in any currency. For more information, visit ","46cc6bc340df0",{"_key":836,"_type":75,"marks":837,"text":828},"46cc6bc340df1",[829],{"_type":75,"marks":839,"text":840,"_key":841},[],".","46cc6bc340df2","6558fb161935",[844,874],{"style":79,"_key":845,"markDefs":846,"children":853,"_type":78},"cd3115128082",[847,850],{"href":848,"_key":849,"_type":105},"https://brokercheck.finra.org/firm/summary/288933","10659f16c05f",{"_type":105,"href":851,"_key":852},"https://www.nfa.futures.org/BasicNet/basic-profile.aspx?nfaid=XCoGScQYyvw%3D","3c111ef5e988",[854,858,862,866,870],{"_key":855,"_type":75,"marks":856,"text":857},"e217f565c4110",[],"Clear Street does not provide investment, legal, regulatory, tax, or compliance advice. Consult professionals in these fields to address your specific circumstances. These materials are: (i) solely an overview of Clear Street’s products and services; (ii) provided for informational purposes only; and (iii) subject to change without notice or obligation to replace any information contained therein.\n\nProducts and services are offered by Clear Street LLC as a Broker Dealer member FINRA and SIPC and a Futures Commission Merchant registered with the CFTC and member of NFA. Additional information about Clear Street is available on FINRA ",{"_type":75,"marks":859,"text":860,"_key":861},[849],"BrokerCheck","e217f565c4111",{"_key":863,"_type":75,"marks":864,"text":865},"e217f565c4112",[],", including its Customer Relationship Summary and NFA ",{"_type":75,"marks":867,"text":868,"_key":869},[852],"BASIC | NFA (futures.org)","e217f565c4113",{"_type":75,"marks":871,"text":872,"_key":873},[],".\n‍\nCopyright © 2024 Clear Street LLC. All rights reserved. Clear Street and the Shield Logo are Registered Trademarks of Clear Street LLC\n","e217f565c4114",{"style":79,"_key":875,"markDefs":876,"children":877,"_type":78},"38805a72b34d",[],[878],{"_type":75,"marks":879,"text":880,"_key":881},[],"\n","a19adde9170f0",{"address":883,"disclaimer":884,"footerItems":911,"legalItems":943,"legalText":5,"socialNetworks":953},"4 World Trade Center\n150 Greenwich St Floor 45\nNew York, NY 10007\n(646) 845-0036",[885,895],{"markDefs":886,"children":889,"_type":78,"style":79,"_key":894},[887],{"_type":105,"href":848,"_key":888},"d38625939708",[890],{"text":891,"_key":892,"_type":75,"marks":893},"Products and services are offered by Clear Street LLC as a Broker Dealer member FINRA and SIPC and a Futures Commission Merchant registered with the CFTC and member of NFA. ","331699fdb6140",[],"b41b74ae73bb",{"markDefs":896,"children":898,"_type":78,"style":79,"_key":910},[897],{"_type":105,"href":848,"_key":888},[899,903,906],{"_type":75,"marks":900,"text":901,"_key":902},[],"Additional information about Clear Street is available on FINRA ","42e587e4d749",{"_type":75,"marks":904,"text":860,"_key":905},[888],"4894062c01ca",{"_type":75,"marks":907,"text":908,"_key":909},[],", including its Customer Relationship Summary and NFA BASIC | NFA (futures.org).","6db9006e1b4a","dbec5081eda7",[912,925,937],{"title":63,"pages":913},[914,918,921,924],{"type":915,"title":916,"slug":917},"internal","About","about",{"type":915,"title":919,"slug":920},"News & Content","news",{"type":915,"title":922,"slug":923},"Careers","careers",{"type":915,"title":41,"slug":42},{"title":926,"pages":927},"Services",[928,931,934],{"type":915,"title":929,"slug":930},"Institutional","institutional",{"type":915,"title":932,"slug":933},"Professional Clearing","professional-clearing",{"type":915,"title":935,"slug":936},"Active Trader","active-trader",{"title":938,"pages":939},"Products",[940],{"type":915,"title":941,"slug":942},"Studio","studio",[944,947,950],{"title":945,"slug":946},"Regulatory Disclosures","regulatory-disclosures",{"title":948,"slug":949},"Privacy Policy","privacy-policy",{"title":951,"slug":952},"Security","security",[954,959,963,967],{"_key":955,"_type":956,"link":957,"socialNetwork":958},"466192507eea","links","https://github.com/clear-street","github",{"_type":956,"link":960,"socialNetwork":961,"_key":962},"https://www.linkedin.com/company/clear-street","linkedin","43f9fa8f49d0",{"_type":956,"link":964,"socialNetwork":965,"_key":966},"https://www.youtube.com/@ClearStreetNYC","youtube","b581a744d770",{"_type":956,"link":968,"socialNetwork":969,"_key":970},"https://open.spotify.com/show/3Bbl6x17ZSdnijTTDq6tKi","spotify","7625c0ffc2b2",1733511758851]