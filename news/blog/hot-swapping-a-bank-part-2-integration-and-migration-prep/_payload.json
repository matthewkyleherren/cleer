[{"data":1,"prerenderedAt":533},["ShallowReactive",2],{"VzQFAdhMAE":3},{"pageSetup":4,"sections":15},{"keywords":5,"image":6,"title":10,"slug":11,"description":14},null,{"url":7,"width":8,"height":9},"https://cdn.sanity.io/images/40fnhjbe/production/49830f76bd7417760075ec42044784a4fe7097ae-3840x2160.png",3840,2160,"Hot Swapping a Bank Part 2: Integration and Migration Prep",{"current":12,"_type":13},"hot-swapping-a-bank-part-2-integration-and-migration-prep","slug","Clear Street is a cloud-native financial technology firm on a mission to modernize the brokerage ecosystem.",{"header":16,"content":39,"footer":444},{"summary":14,"author":17,"category":34,"title":10,"date":37,"hello":38},{"_updatedAt":18,"role":19,"_createdAt":20,"name":21,"slug":22,"_rev":24,"_type":25,"photo":26,"_id":33},"2024-05-30T15:04:12Z","","2024-02-16T14:38:42Z","Clear Street Engineering",{"current":23,"_type":13},"clear-street-engineering","oquihqXh9OzAvkinFGpwlk","authors",{"width":27,"height":27,"extension":28,"alt":5,"hotspot":5,"asset":29,"url":32},480,"png",{"_ref":30,"_type":31},"image-f9f54b5f5240dfdb9749b6abea1e0ea4720c0dee-480x480-png","reference","https://cdn.sanity.io/images/40fnhjbe/production/f9f54b5f5240dfdb9749b6abea1e0ea4720c0dee-480x480.png","FY3Umrpkptjq2bXyZZikKw",{"name":35,"colorSlug":36},"Engineering","engineering","2022-07-07","world",{"readingTime":40,"body":41,"references":348,"pressReleasesFootNote":349,"legalText":375,"form":414,"type":443},7,[42,52,60,67,75,85,93,100,108,115,123,130,138,148,156,168,180,192,204,212,220,228,236,244,252,259,267,275,283,290,298,306,313,321,328],{"markDefs":43,"children":44,"_type":49,"style":50,"_key":51},[],[45],{"_type":46,"marks":47,"text":19,"_key":48},"span",[],"e808829062df0","block","normal","e808829062df",{"children":53,"_type":49,"style":50,"_key":58,"markDefs":59},[54],{"marks":55,"text":56,"_key":57,"_type":46},[],"BK is Clear Street’s proprietary transaction processing system, used to process more than $3 billion in daily trading volume. BK is the newer, faster version of our legacy Book Keeping system, Bank. Where Bank had issues with low throughput, data modeling, and messy points of extension, BK is more agile and scalable, to support our growing business.","ed059a60036e0","ed059a60036e",[],{"_key":61,"markDefs":62,"children":63,"_type":49,"style":50},"687855a6aea6",[],[64],{"marks":65,"text":19,"_key":66,"_type":46},[],"687855a6aea60",{"children":68,"_type":49,"style":50,"_key":73,"markDefs":74},[69],{"text":70,"_key":71,"_type":46,"marks":72},"In part 1 of this series, I outlined how we identified areas for improvement within Bank and used a data validation system to ensure we were solving those issues when we built BK. In part 2, I’ll discuss how we approached compatibility layers and data migration.","c64a83f49a010",[],"c64a83f49a01",[],{"style":76,"_key":77,"markDefs":78,"children":79,"_type":49},"h5","23b4f274828d",[],[80],{"_type":46,"marks":81,"text":83,"_key":84},[82],"strong","Speaking in “Bank”","23b4f274828d0",{"style":50,"_key":86,"markDefs":87,"children":88,"_type":49},"a3f005c75cba",[],[89],{"_type":46,"marks":90,"text":91,"_key":92},[],"After thorough testing, our next challenge was to integrate existing services with BK. Initially, we aimed to have all clients of the system migrate to BK pre-release. As we began to understand the complexity of the release, it became apparent that this would create significant risk and take a lot of time.","a3f005c75cba0",{"children":94,"_type":49,"style":50,"_key":98,"markDefs":99},[95],{"_type":46,"marks":96,"text":19,"_key":97},[],"6429ab01c0780","6429ab01c078",[],{"style":50,"_key":101,"markDefs":102,"children":103,"_type":49},"cf1228372e61",[],[104],{"_type":46,"marks":105,"text":106,"_key":107},[],"We chose to build a Façade service to release BK without needing to update multiple services in different programming languages, while simultaneously ensuring every single service kept the same behavior between the old system and the new one.","cf1228372e610",{"style":50,"_key":109,"markDefs":110,"children":111,"_type":49},"9ffb508fb6fe",[],[112],{"marks":113,"text":19,"_key":114,"_type":46},[],"9ffb508fb6fe0",{"markDefs":116,"children":117,"_type":49,"style":50,"_key":122},[],[118],{"_type":46,"marks":119,"text":120,"_key":121},[],"This service implements the APIs of Bank, fully backed by BK, and concentrates all the necessary adapter logic into a single service. The process was not simple. It required a lot of testing and some trade-offs, but in the end, it enabled us to test other services using BK without even touching them.","2487f41a794b0","2487f41a794b",{"_type":49,"style":50,"_key":124,"markDefs":125,"children":126},"5813435f5bec",[],[127],{"text":19,"_key":128,"_type":46,"marks":129},"5813435f5bec0",[],{"children":131,"_type":49,"style":50,"_key":136,"markDefs":137},[132],{"_type":46,"marks":133,"text":134,"_key":135},[],"To make the switch as seamless as possible, we used a few interesting approaches:","8c5e8d03aa720","8c5e8d03aa72",[],{"markDefs":139,"children":140,"level":145,"_type":49,"style":50,"_key":146,"listItem":147},[],[141],{"_type":46,"marks":142,"text":143,"_key":144},[],"Our Kubernetes service for the Façade took over Bank’s name (DNS and Consul registration), and we renamed Bank to legacy-Bank. This connected services to BK the same way they always connected to Bank, allowing the Façade to properly handle clients’ requests.","78caaa112c780",1,"78caaa112c78","bullet",{"markDefs":149,"children":150,"_type":49,"style":50,"_key":155},[],[151],{"_type":46,"marks":152,"text":153,"_key":154},[],"The configuration of Façade supported multiple modes:","e7a1119ac8d30","e7a1119ac8d3",{"_key":157,"listItem":147,"markDefs":158,"children":159,"level":145,"_type":49,"style":50},"c0f4f57aede3",[],[160,164],{"_key":161,"_type":46,"marks":162,"text":163},"c0f4f57aede30",[82],"bank-only ",{"_key":165,"_type":46,"marks":166,"text":167},"c0f4f57aede31",[],"— In this mode, the Façade is just a reverse proxy, and every request is simply forwarded to the legacy service (Bank).",{"markDefs":169,"children":170,"level":145,"_type":49,"style":50,"_key":179,"listItem":147},[],[171,175],{"_type":46,"marks":172,"text":173,"_key":174},[82],"bank-primary-bk-secondary","e7b29af2e70c0",{"_type":46,"marks":176,"text":177,"_key":178},[]," — In this mode, requests are proxied to Bank, but also forwarded to BK. If BK fails to process the request for any reason, the failure won’t affect the client’s request. The data for all reads still comes from Bank.","e7b29af2e70c1","e7b29af2e70c",{"_type":49,"style":50,"_key":181,"listItem":147,"markDefs":182,"children":183,"level":145},"62b32951c6ec",[],[184,188],{"_type":46,"marks":185,"text":186,"_key":187},[82],"bk-primary-bank-secondary ","62b32951c6ec0",{"_key":189,"_type":46,"marks":190,"text":191},"62b32951c6ec1",[],"— In this mode, requests go to BK primarily, and if processing fails, the client will receive an error. Requests are forwarded to Bank as well, but if Bank fails, the client requests do not fail, they go to BK.",{"_type":49,"style":50,"_key":193,"listItem":147,"markDefs":194,"children":195,"level":145},"1e51a3234a6e",[],[196,200],{"_type":46,"marks":197,"text":198,"_key":199},[82],"bk-only ","1e51a3234a6e0",{"_type":46,"marks":201,"text":202,"_key":203},[],"— In this mode, Bank doesn’t see any more data. It’s effectively 100% BK speaking in Bank API.","1e51a3234a6e1",{"markDefs":205,"children":206,"_type":49,"style":50,"_key":211},[],[207],{"_type":46,"marks":208,"text":209,"_key":210},[],"We orchestrated multiple deployments with several milestones until the final release, when Bank was no longer needed. These milestones were:","4f92c5d869910","4f92c5d86991",{"children":213,"level":145,"_type":49,"style":50,"_key":218,"listItem":147,"markDefs":219},[214],{"_type":46,"marks":215,"text":216,"_key":217},[],"Release the Façade service deployed in bank-only mode, and verify that introducing this new hop does not create any issues.","097176f0ec940","097176f0ec94",[],{"style":50,"_key":221,"listItem":147,"markDefs":222,"children":223,"level":145,"_type":49},"8ff93b5ef9a5",[],[224],{"marks":225,"text":226,"_key":227,"_type":46},[],"Multiplex data to BK, deployed in bank-primary-bk-secondary mode. This allows us to have the two systems source their data from the same source, which is incredibly helpful in validating that the systems are equivalent.","8ff93b5ef9a50",{"level":145,"_type":49,"style":50,"_key":229,"listItem":147,"markDefs":230,"children":231},"06ed0ad67b6d",[],[232],{"_type":46,"marks":233,"text":234,"_key":235},[],"Make BK primary, deployed in bk-primary-bank-secondary mode. At this milestone, we had decided that BK is the source of truth, and we kept Bank around in case of catastrophic failure (which never happened!)","06ed0ad67b6d0",{"markDefs":237,"children":238,"level":145,"_type":49,"style":50,"_key":243,"listItem":147},[],[239],{"marks":240,"text":241,"_key":242,"_type":46},[],"Tests ran in bk-only mode, which enabled us to make sure that BK was getting hit as hard as possible by all of our automated tests, because ultimately this is what we care about the most.","064fb4fbbeb80","064fb4fbbeb8",{"markDefs":245,"children":246,"_type":49,"style":50,"_key":251},[],[247],{"text":248,"_key":249,"_type":46,"marks":250},"At this point, I’ve only discussed the RPC compatibility layer, but it wasn’t this simple. Bank also contained an event layer, which hydrates our Data Warehouse and other downstream services. For this use case, we introduced a service called the “Façade Stream,” a Kafka consumer and producer, which translated the BK event stream into the Bank equivalent. Introducing the Façade Stream was difficult for a few reasons, but primarily because it required us to rehydrate data in different ways because of critical differences in the Bank and BK data models.","868141f8fa3f0",[],"868141f8fa3f",{"markDefs":253,"children":254,"_type":49,"style":50,"_key":258},[],[255],{"_type":46,"marks":256,"text":19,"_key":257},[],"51eb31d6b9740","51eb31d6b974",{"markDefs":260,"children":261,"_type":49,"style":50,"_key":266},[],[262],{"_type":46,"marks":263,"text":264,"_key":265},[],"The output of BK’s façade stream and Bank’s event stream are meant to match very closely and the output of both systems landed in our common data warehouse, Snowflake, which enabled us to perform validation against these data streams at scale through SQL.","e70b0458f58e0","e70b0458f58e",{"markDefs":268,"children":269,"_type":49,"style":76,"_key":274},[],[270],{"_type":46,"marks":271,"text":272,"_key":273},[82],"The Old Is New Again","faa0ad11df590","faa0ad11df59",{"_key":276,"markDefs":277,"children":278,"_type":49,"style":50},"3816fcf0cd23",[],[279],{"_type":46,"marks":280,"text":281,"_key":282},[],"A critical factor I have not yet mentioned is that all of the data in Bank also needed to be available in BK. To complicate things further, Bank and BK have fairly different data models. Well, that’s a little gremlin that reared its ugly head multiple times as we worked towards migrating the data from Bank and loading it into BK.","3816fcf0cd230",{"style":50,"_key":284,"markDefs":285,"children":286,"_type":49},"3398849547b6",[],[287],{"_key":288,"_type":46,"marks":289,"text":19},"3398849547b60",[],{"_type":49,"style":50,"_key":291,"markDefs":292,"children":293},"0068b66033fa",[],[294],{"_type":46,"marks":295,"text":296,"_key":297},[],"We wrote an application that we called the “Bootstrapper” to fetch data from Bank, map it into the BK equivalent, and load it into BK’s datastore. The process of “bootstrapping” is fairly complex because we were mapping Bank’s data model again into BK’s and it required handling many edge cases within that translation and re-enriching data to make it “whole” for BK to function properly.","0068b66033fa0",{"markDefs":299,"children":300,"_type":49,"style":50,"_key":305},[],[301],{"_type":46,"marks":302,"text":303,"_key":304},[],"BK’s core database is AWS Aurora (Postgres flavor). One of the many wonderful things about it is that it supports loading and unloading data to and from S3. The Bootstrapper leveraged this to perform large data operations within its migration workflows.","1605520351ba0","1605520351ba",{"children":307,"_type":49,"style":50,"_key":311,"markDefs":312},[308],{"_type":46,"marks":309,"text":19,"_key":310},[],"7ca892fcd5b80","7ca892fcd5b8",[],{"_key":314,"markDefs":315,"children":316,"_type":49,"style":50},"ee69644b7b1d",[],[317],{"text":318,"_key":319,"_type":46,"marks":320},"To put it simply, this process was extremely complex. We were overjoyed when we got to delete the code for this application. When migrating data, it’s critical to plan ahead, be ready to continuously discover edge cases, and factor in additional time, because it will take much longer than expected.","ee69644b7b1d0",[],{"markDefs":322,"children":323,"_type":49,"style":50,"_key":327},[],[324],{"_type":46,"marks":325,"text":19,"_key":326},[],"6d653a38905c0","6d653a38905c",{"style":50,"_key":329,"markDefs":330,"children":335,"_type":49},"747d1fb44f3e",[331],{"_type":332,"to":333,"_key":334},"link","https://www.clearstreet.io/insights/hot-swapping-a-bank-part-3-deployment-and-life-lessons","055c271bfce1",[336,340,344],{"_type":46,"marks":337,"text":338,"_key":339},[],"The Bootstrapper lived for a whole year, and we were making adjustments to get all the data correctly loaded into BK until the very end. Once we handled compatibility and proper data migration, we were ready for deployment, which I’ll cover in ","747d1fb44f3e0",{"_type":46,"marks":341,"text":342,"_key":343},[334],"part 3","747d1fb44f3e1",{"_type":46,"marks":345,"text":346,"_key":347},[],".","747d1fb44f3e2",[],[350,358],{"style":50,"_key":351,"markDefs":352,"children":353,"_type":49},"01d9743bd6e6",[],[354],{"_type":46,"marks":355,"text":356,"_key":357},[82],"About Clear Street:","820e76cb468a0",{"_key":359,"markDefs":360,"children":364,"_type":49,"style":50},"6558fb161935",[361],{"_type":332,"href":362,"_key":363},"https://clearstreet.io","f69e401d33e9",[365,369,372],{"text":366,"_key":367,"_type":46,"marks":368},"Clear Street is modernizing the brokerage ecosystem with financial technology and services that empower market participants with real-time data and best-in-class products, tools and teams, to navigate capital markets around the world. Complemented by white-glove service, Clear Street's cloud-native, proprietary product suite delivers financing, derivatives, execution and more to power client success, adding efficiency to the market and enabling clients to minimize risk, redundancy and cost. Clear Street’s goal is to create a single platform for every asset class, in every country and in any currency. For more information, visit ","46cc6bc340df0",[],{"_type":46,"marks":370,"text":362,"_key":371},[363],"46cc6bc340df1",{"_type":46,"marks":373,"text":346,"_key":374},[],"46cc6bc340df2",[376,406],{"_type":49,"style":50,"_key":377,"markDefs":378,"children":385},"cd3115128082",[379,382],{"_type":332,"href":380,"_key":381},"https://brokercheck.finra.org/firm/summary/288933","10659f16c05f",{"_type":332,"href":383,"_key":384},"https://www.nfa.futures.org/BasicNet/basic-profile.aspx?nfaid=XCoGScQYyvw%3D","3c111ef5e988",[386,390,394,398,402],{"_type":46,"marks":387,"text":388,"_key":389},[],"Clear Street does not provide investment, legal, regulatory, tax, or compliance advice. Consult professionals in these fields to address your specific circumstances. These materials are: (i) solely an overview of Clear Street’s products and services; (ii) provided for informational purposes only; and (iii) subject to change without notice or obligation to replace any information contained therein.\n\nProducts and services are offered by Clear Street LLC as a Broker Dealer member FINRA and SIPC and a Futures Commission Merchant registered with the CFTC and member of NFA. Additional information about Clear Street is available on FINRA ","e217f565c4110",{"_type":46,"marks":391,"text":392,"_key":393},[381],"BrokerCheck","e217f565c4111",{"_type":46,"marks":395,"text":396,"_key":397},[],", including its Customer Relationship Summary and NFA ","e217f565c4112",{"text":399,"_key":400,"_type":46,"marks":401},"BASIC | NFA (futures.org)","e217f565c4113",[384],{"_type":46,"marks":403,"text":404,"_key":405},[],".\n‍\nCopyright © 2024 Clear Street LLC. All rights reserved. Clear Street and the Shield Logo are Registered Trademarks of Clear Street LLC\n","e217f565c4114",{"_type":49,"style":50,"_key":407,"markDefs":408,"children":409},"38805a72b34d",[],[410],{"_type":46,"marks":411,"text":412,"_key":413},[],"\n","a19adde9170f0",{"title":415,"slug":416,"fields":417},"Contact","contact",[418,424,429,434,438],{"required":419,"errorMessage":420,"_type":421,"name":422,"label":423},true,"Please add your full name","field.string","full-name","Full name",{"_type":425,"name":426,"label":427,"required":419,"errorMessage":428},"field.email","work-email","Work email","Invalid email",{"label":430,"required":419,"errorMessage":431,"_type":432,"name":433},"Work phone","Please add your work phone","field.phone","work-phone",{"name":435,"label":436,"required":419,"errorMessage":437,"_type":421},"company","Company","Please add your company",{"name":439,"label":440,"required":441,"errorMessage":5,"_type":442},"message","Message (optional)",false,"field.text","blog",{"legalText":5,"socialNetworks":445,"address":463,"disclaimer":464,"footerItems":491,"legalItems":523},[446,451,455,459],{"socialNetwork":447,"_key":448,"_type":449,"link":450},"github","466192507eea","links","https://github.com/clear-street",{"_type":449,"link":452,"socialNetwork":453,"_key":454},"https://www.linkedin.com/company/clear-street","linkedin","43f9fa8f49d0",{"_type":449,"link":456,"socialNetwork":457,"_key":458},"https://www.youtube.com/@ClearStreetNYC","youtube","b581a744d770",{"_type":449,"link":460,"socialNetwork":461,"_key":462},"https://open.spotify.com/show/3Bbl6x17ZSdnijTTDq6tKi","spotify","7625c0ffc2b2","4 World Trade Center\n150 Greenwich St Floor 45\nNew York, NY 10007\n(646) 845-0036",[465,475],{"markDefs":466,"children":469,"_type":49,"style":50,"_key":474},[467],{"_type":332,"href":380,"_key":468},"d38625939708",[470],{"_type":46,"marks":471,"text":472,"_key":473},[],"Products and services are offered by Clear Street LLC as a Broker Dealer member FINRA and SIPC and a Futures Commission Merchant registered with the CFTC and member of NFA. ","331699fdb6140","b41b74ae73bb",{"style":50,"_key":476,"markDefs":477,"children":479,"_type":49},"dbec5081eda7",[478],{"_type":332,"href":380,"_key":468},[480,484,487],{"_type":46,"marks":481,"text":482,"_key":483},[],"Additional information about Clear Street is available on FINRA ","42e587e4d749",{"_type":46,"marks":485,"text":392,"_key":486},[468],"4894062c01ca",{"marks":488,"text":489,"_key":490,"_type":46},[],", including its Customer Relationship Summary and NFA BASIC | NFA (futures.org).","6db9006e1b4a",[492,505,517],{"title":436,"pages":493},[494,498,501,504],{"type":495,"title":496,"slug":497},"internal","About","about",{"type":495,"title":499,"slug":500},"News & Content","news",{"type":495,"title":502,"slug":503},"Careers","careers",{"type":495,"title":415,"slug":416},{"title":506,"pages":507},"Services",[508,511,514],{"type":495,"title":509,"slug":510},"Institutional","institutional",{"type":495,"title":512,"slug":513},"Professional Clearing","professional-clearing",{"type":495,"title":515,"slug":516},"Active Trader","active-trader",{"title":518,"pages":519},"Products",[520],{"type":495,"title":521,"slug":522},"Studio","studio",[524,527,530],{"title":525,"slug":526},"Regulatory Disclosures","regulatory-disclosures",{"title":528,"slug":529},"Privacy Policy","privacy-policy",{"title":531,"slug":532},"Security","security",1733511757967]